#!/usr/bin/env python3

# Copyright 2025 Marek Antoni Kurczynski (also known as Mark Alexander Anthony)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from help import print_help
from gill_init import gill_init
from aliases import aliases
from gill_sysprompt import gill_sysprompt
from gill_config import gill_config, load_config
from prompt_parser import parse_prompt_args                     # Import the parser for prompt instructions
from llm_api import ask_openai                                  # Import API call function

import sys
import os

def main() -> None:
    DEBUG_BOOL: bool = False
    testBool: bool = False                                      # Set True with `--test` flag

    args = sys.argv
    if len(args) > 1:
        args = args[1:]                                         # Cut out the `gill` command
        if DEBUG_BOOL:
            print(f"args are: ", args)
    else: 
        # Deal with case of no commands
        print_help("gill")
        return

    match args[0]:
        case "init":
            args = args[1:]                                     # Cut out the `init` command
            if len(args) < 2:
                arg = args[0] if len(args) > 0 else None        # Either has one more command for directory or None
                try:
                    gill_init(DEBUG_BOOL, arg)
                    return
                except Exception as e:
                    print(f"Error: {e}", file=sys.stderr)
            print_help("gill init")
            sys.exit(1)
        case "config" | "configuration":
            args = args[1:]                                     # Cut out `config` command
            if len(args) > 0:
                try:
                    gill_config(args)
                    return
                except Exception as e:
                    print(f"Error: {e}", file=sys.stderr)
            print_help("gill_config")
            sys.exit(1)
        case value if value in aliases("sysprompt"):
            args = args[1:]                                     # Cut out `sysprompt` command
            if len(args) == 0:                                  # Only accept no commands
                try:
                    gill_sysprompt()
                    return
                except Exception as e:
                    print(f"Error: {e}", file=sys.stderr)
            print_help("gill sysprompt")
            sys.exit(1)
        case "chat": # TODO: commands for new chat, switching chat, deleting chat, listing, showing
            args = args[1:]                                     # Cut out `chat` command
            if len(args) == 1 and args[0] == "delete":
                
        case "--test" | "-t":
            testBool = True
            args = args[1:]
        # TODO: --help command

    # Create prompt to send (or test)
    try:
        prompt = parse_prompt_args(args)
    except ValueError as e:
        print(f"Argument error: {e}", file=sys.stderr)
        sys.exit(1)
    if prompt == "":
        print("Error: Provide at least one -m or -f option with content.", file=sys.stderr)
        sys.exit(1)

    # If testing, just print
    if testBool or DEBUG_BOOL:
        print(prompt)
        return
    
    # Check for chat head
    cwd = os.getcwd()
    config_path = os.path.join(cwd, ".gill", "config.toml")
    if os.path.exists(config_path):
        config = load_config(config_path)
        chats = config.get("chats")
        if chats:
            head = chats.get("head")
        else:
            # No chats in config, so create a chat file and make it head
            chats_path = os.path.join(cwd, ".gill", "chats")
            if not (os.path.exists(chats_path) and os.path.isdir(chats_path)):
                os.makedirs(chats_path)
            # TODO: create chat file that's not already there
            # TODO: make head, add to config
            head = "Not none"
    else:
        head = None

    # Get streaming response
    try:
        result = ""
        cc_stream = ask_openai(prompt)                # Call OpenAI API function
        for event in cc_stream:
            # Only accumulate the text deltas
            content_delta = event.choices[0].delta.content
            if content_delta:
                result += content_delta
                print(content_delta, end="", flush=True)
            # You can handle other event types if you want: e.g., done, content_part.done, etc.
        print() # flush newline at end of stream
    except Exception as e:
        print(f"OpenAI API error: {e}", file=sys.stderr)
        sys.exit(1)

    if head:
        # TODO: Add result to file
        print(result)

if __name__ == "__main__":
    main()